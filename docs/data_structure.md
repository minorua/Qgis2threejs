# Python â†” Web Data Exchange (Qgis2threejs)

Created: January 24, 2026

Note: This document was generated by AI (GitHub Copilot, GPT-5).

This document describes the JSON data exchanged between the Python export layer and the web viewer (`web/js/Qgis2threejs.js`). It covers the scene envelope, layer payloads, block streaming, materials/models, and optional animation.

References:
- Viewer: [web/js/Qgis2threejs.js](web/js/Qgis2threejs.js)
- Scene builder: [core/build/builder.py](core/build/builder.py)
- DEM builders: [core/build/dem/builder.py](core/build/dem/builder.py), [core/build/dem/grid_builder.py](core/build/dem/grid_builder.py), [core/build/dem/material_builder.py](core/build/dem/material_builder.py)
- Vector builders: [core/build/vector/builder.py](core/build/vector/builder.py), [core/build/vector/feature_block_builder.py](core/build/vector/feature_block_builder.py), [core/build/vector/object.py](core/build/vector/object.py)
- Point cloud builder: [core/build/pointcloud/builder.py](core/build/pointcloud/builder.py)

## Overview

- Data is delivered as JSON objects with `type` among `scene`, `layer`, or `block`.
- The viewer loads a scene, then layers, and streams additional blocks on demand.
- Vector layers either inline features in a block or reference external block JSON by URL.
- DEM layers send grid elevation data per block (raw bytes via URL, base64, or preview binary), or clipped triangle meshes.
- Materials and models are pre-declared per layer body and referenced by index in features/blocks.
- Optional `animation.tracks` may be included at the scene level.

## Scene JSON

A scene envelope sets world and camera context and may contain layers.

```json
{
  "type": "scene",
  "properties": {
    "baseExtent": {"cx": Number, "cy": Number, "width": Number, "height": Number, "rotation": Number},
    "origin": {"x": Number, "y": Number, "z": Number},
    "zScale": Number,
    "light": "directional" | "point",
    "fog": {"color": Integer, "density": Number},
    "proj": String,
    "pivot": [internal; computed in viewer]
  },
  "layers": [Layer]
}
```

Notes:
- `proj` is optional and used for lat/lon display.
- The viewer computes `pivot` and initial camera from `baseExtent` and `origin`.

## Layer JSON

Common fields:

```json
{
  "type": "layer",
  "id": Integer,
  "properties": {
    "name": String,
    "clickable": Boolean,
    "visible": Boolean,
    "type": "dem" | "point" | "line" | "polygon" | "pc",
    // type-specific additions...
  },
  "body": { /* optional; type-specific */ }
}
```

### DEM layer (`properties.type = "dem"`)

```json
{
  "properties": {
    "type": "dem",
    "clipped": Boolean,
    "tiled": Boolean,
    "mtlNames": [String],
    "mtlIdx": Integer
  },
  "body": {
    "blocks": [BlockDEM]
  }
}
```

Each `BlockDEM` contains either a grid or clipped geometry, and may carry materials/wireframe/sides/edges.

### Vector layer (`properties.type in {"point","line","polygon"}`)

```json
{
  "properties": {
    "type": "point" | "line" | "polygon",
    "objType": "Point" | "Billboard" | "3D Model" | "Sphere" | "Cylinder" | "Cone" | "Box" | "Disk" | "Plane" | "Line" | "Thick Line" | "Pipe" | "Cone" | "Box" | "Wall" | "Polygon" | "Extruded" | "Overlay",
    "propertyNames": [String],
    "label": {
      "relative": Boolean,
      "font": String,
      "size": Integer,
      "color": String,
      "olcolor": String,
      "bgcolor": String,
      "cncolor": Integer,
      "underline": Boolean
    }
  },
  "body": {
    "materials": [Material],            // for non-"3D Model" objTypes
    "models": [Model],                  // for "3D Model" objType
    "blocks": [BlockVector]
  }
}
```

Feature attributes (`prop`) are aligned with `propertyNames`. Labels per feature use `lbl` and `lh`.

### Point cloud layer (`properties.type = "pc"`)

```json
{
  "properties": {
    "type": "pc",
    "url": String,          // Potree metadata URL
    "opacity": Number,
    "colorType": "RGB" | "COLOR",
    "color": Integer,       // when colorType == "COLOR"
    "boxVisible": Boolean
  }
}
```

## Block JSON

Blocks stream layer content. The viewer routes `type = "block"` by `layer` id.

### DEM block (`BlockDEM`)

Grid variant:
```json
{
  "type": "block",
  "layer": Integer,
  "block": Integer,
  "width": Number,           // base plane width
  "height": Number,          // base plane height
  "translate": [Number, Number, Number],
  "zScale": Number,
  "grid": {
    "width": Integer,        // columns
    "height": Integer,       // rows
    "base64": String |       // mutually exclusive
    "binary": {} |           // preview (QByteArray)
    "url": String            // .bin
  },
  "materials": [MaterialUse],
  "wireframe": {"mtl": Material},
  "sides": {"mtl": Material, "bottom": Number},
  "edges": {"mtl": Material}
}
```

Tile variant:
```json
{
  "type": "block",
  "layer": Integer,
  "block": Integer,
  "segments": Integer,       // grid segments per tile side
  "tileSize": Number,        // in map units
  "translate": [Number, Number, Number],
  "zScale": Number,
  "grid": {"width": Integer, "height": Integer, "base64" | "binary" | "url": ...}
}
```

Clipped variant:
```json
{
  "type": "block",
  "layer": Integer,
  "block": Integer,
  "translate": [Number, Number, Number],
  "zScale": Number,
  "geom": {
    "triangles": {"v": [Number...], "f": [Integer...]},
    "polygons": [[[Number,Number,Number]...], ...]
  },
  "materials": [MaterialUse],
  "sides": {"mtl": Material, "bottom": Number},
  "edges": {"mtl": Material}
}
```

`MaterialUse` entries add `mtlIndex` and `useNow` to a `Material` so the viewer can switch textures.

### Vector block (`BlockVector`)

Inline:
```json
{
  "type": "block",
  "layer": Integer,
  "block": Integer,
  "features": [Feature],
  "featureCount": Integer,
  "startIndex": Integer
}
```

By URL (export mode):
```json
{ "url": String, "featureCount": Integer }
```

#### Feature geometry shapes

- Point sprites: `{ "pts": [x,y,z,...] }`
- Sphere: `{ "pts": [[x,y,z]...], "r": Number }`
- Cylinder/Cone: `{ "pts": [[x,y,z]...], "r": Number, "h": Number }`
- Box: `{ "pts": [[x,y,z]...], "w": Number, "d": Number, "h": Number }`
- Disk: `{ "pts": [[x,y,z]...], "r": Number, "d": Number, "dd": Number }`
- Plane: `{ "pts": [[x,y,z]...], "w": Number, "l": Number, "d": Number, "dd": Number }`
- Points cloud (material Points): `{ "pts": [x,y,z,...] }`
- Line: `{ "lines": [[x,y,z]... repeated per polyline] }`
- Thick Line: `{ "lines": [[x,y,z]... repeated], /* material MeshLine */ }`
- Pipe/Cone line: `{ "lines": [[[x,y,z]...], ...], "r": Number }`
- Box line: `{ "lines": [[[x,y,z]...], ...], "w": Number, "h": Number }`
- Wall: `{ "lines": [x,y,z,...], "bh": Number }`
- Polygon: `{ "triangles": {"v": [Number...], "f": [Integer...] } }`
- Extruded: `{ "polygons": [[[x,y]...],...], "centroids": [[x,y,z]...], "h": Number }`
- Overlay: `{ "triangles": {...}, "brdr": [[[x,y,z]...], ...] }`

Each feature may also include:
- `mtl`: `{ "idx": Integer, ... }` referring into `body.materials`
- `model`: Integer index into `body.models`
- `prop`: [Any...] attribute values aligned to `propertyNames`
- `lbl`: String label text, `lh`: Number label height
- `anim`: `{ "delay": Integer, "duration": Integer }`

## Materials and Models

Material objects (from Python) carry both color and image-based definitions and map to viewer types:

```json
{
  "type": 0|1|2|3|4|5|6|7,     // viewer material type; numbers per MaterialManager/Q3D.MaterialType
  "c": Integer,                // color (if color-based)
  "o": Number,                 // opacity (<1 implies transparent)
  "ds": 1,                    // double-sided
  "t": 1,                     // transparent hint
  "w": 1,                     // wireframe
  "flat": 1,                  // flat shading
  "bm": true,                 // basic (no shading)
  "s": Number,                // point size
  "dashed": true,             // line dashed
  "thickness": Number,        // mesh line thickness
  "image": { "url"|"base64"|"object": ... }
}
```

Model entries:
```json
{ "url": String } | { "base64": String, "ext": "dae"|"gltf"|"glb", "resourcePath": String }
```

## Animation (optional)

At the scene level, Python may include:
```json
{ "animation": { "tracks": [ /* tracks */ ] } }
```
The viewer applies supported tweens (camera motion, opacity, texture switching, growing line).

---

# JSON Schema

The schema below captures the structure used by the viewer and builders. It focuses on the main envelope and common variants; additional keys may exist for future extensions.

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://qgis2threejs.org/schema/scene.json",
  "title": "Qgis2threejs Scene",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/Scene" },
    { "$ref": "#/$defs/Layer" },
    { "$ref": "#/$defs/Block" }
  ],
  "$defs": {
    "Scene": {
      "type": "object",
      "properties": {
        "type": { "const": "scene" },
        "properties": { "$ref": "#/$defs/SceneProperties" },
        "layers": {
          "type": "array",
          "items": { "$ref": "#/$defs/Layer" }
        },
        "animation": {
          "type": "object",
          "properties": {
            "tracks": { "type": "array" }
          },
          "additionalProperties": true
        }
      },
      "required": ["type", "properties"]
    },

    "SceneProperties": {
      "type": "object",
      "properties": {
        "baseExtent": {
          "type": "object",
          "properties": {
            "cx": { "type": "number" },
            "cy": { "type": "number" },
            "width": { "type": "number" },
            "height": { "type": "number" },
            "rotation": { "type": "number" }
          },
          "required": ["cx","cy","width","height","rotation"]
        },
        "origin": {
          "type": "object",
          "properties": {
            "x": { "type": "number" },
            "y": { "type": "number" },
            "z": { "type": "number" }
          },
          "required": ["x","y","z"]
        },
        "zScale": { "type": "number" },
        "light": { "enum": ["directional","point"] },
        "fog": {
          "type": "object",
          "properties": {
            "color": { "type": "integer" },
            "density": { "type": "number" }
          },
          "required": ["color","density"]
        },
        "proj": { "type": "string" }
      },
      "required": ["baseExtent","origin","zScale","light"]
    },

    "Layer": {
      "type": "object",
      "properties": {
        "type": { "const": "layer" },
        "id": { "type": "integer" },
        "properties": { "$ref": "#/$defs/LayerProperties" },
        "body": { "$ref": "#/$defs/LayerBody" }
      },
      "required": ["type","id","properties"]
    },

    "LayerProperties": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "clickable": { "type": "boolean" },
        "visible": { "type": "boolean" },
        "type": { "enum": ["dem","point","line","polygon","pc"] },
        "objType": { "type": "string" },
        "propertyNames": { "type": "array", "items": { "type": "string" } },
        "label": {
          "type": "object",
          "properties": {
            "relative": { "type": "boolean" },
            "font": { "type": "string" },
            "size": { "type": "integer" },
            "color": { "type": "string" },
            "olcolor": { "type": "string" },
            "bgcolor": { "type": "string" },
            "cncolor": { "type": "integer" },
            "underline": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "clipped": { "type": "boolean" },
        "tiled": { "type": "boolean" },
        "mtlNames": { "type": "array", "items": { "type": "string" } },
        "mtlIdx": { "type": "integer" },
        "url": { "type": "string" },
        "opacity": { "type": "number" },
        "colorType": { "enum": ["RGB","COLOR"] },
        "color": { "type": "integer" },
        "boxVisible": { "type": "boolean" }
      },
      "required": ["name","clickable","visible","type"]
    },

    "LayerBody": {
      "type": "object",
      "properties": {
        "materials": { "type": "array", "items": { "$ref": "#/$defs/Material" } },
        "models": { "type": "array", "items": { "$ref": "#/$defs/Model" } },
        "blocks": { "type": "array", "items": { "$ref": "#/$defs/Block" } }
      },
      "additionalProperties": true
    },

    "Block": {
      "type": "object",
      "oneOf": [
        { "$ref": "#/$defs/BlockDEMGrid" },
        { "$ref": "#/$defs/BlockDEMTile" },
        { "$ref": "#/$defs/BlockDEMClipped" },
        { "$ref": "#/$defs/BlockVector" },
        { "$ref": "#/$defs/BlockByUrl" }
      ]
    },

    "BlockBase": {
      "type": "object",
      "properties": {
        "type": { "const": "block" },
        "layer": { "type": "integer" },
        "block": { "type": "integer" },
        "translate": { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 },
        "zScale": { "type": "number" }
      },
      "required": ["type","layer","block"]
    },

    "BlockDEMGrid": {
      "allOf": [
        { "$ref": "#/$defs/BlockBase" },
        {
          "type": "object",
          "properties": {
            "width": { "type": "number" },
            "height": { "type": "number" },
            "grid": { "$ref": "#/$defs/Grid" },
            "materials": { "type": "array", "items": { "$ref": "#/$defs/MaterialUse" } },
            "wireframe": { "$ref": "#/$defs/MaterialWrap" },
            "sides": { "$ref": "#/$defs/Sides" },
            "edges": { "$ref": "#/$defs/MaterialWrap" }
          },
          "required": ["grid"]
        }
      ]
    },

    "BlockDEMTile": {
      "allOf": [
        { "$ref": "#/$defs/BlockBase" },
        {
          "type": "object",
          "properties": {
            "segments": { "type": "integer" },
            "tileSize": { "type": "number" },
            "grid": { "$ref": "#/$defs/Grid" },
            "materials": { "type": "array", "items": { "$ref": "#/$defs/MaterialUse" } }
          },
          "required": ["segments","tileSize","grid"]
        }
      ]
    },

    "BlockDEMClipped": {
      "allOf": [
        { "$ref": "#/$defs/BlockBase" },
        {
          "type": "object",
          "properties": {
            "geom": { "$ref": "#/$defs/TrianglesWithPolygons" },
            "materials": { "type": "array", "items": { "$ref": "#/$defs/MaterialUse" } },
            "sides": { "$ref": "#/$defs/Sides" },
            "edges": { "$ref": "#/$defs/MaterialWrap" }
          },
          "required": ["geom"]
        }
      ]
    },

    "BlockVector": {
      "allOf": [
        { "$ref": "#/$defs/BlockBase" },
        {
          "type": "object",
          "properties": {
            "features": { "type": "array", "items": { "$ref": "#/$defs/Feature" } },
            "featureCount": { "type": "integer" },
            "startIndex": { "type": "integer" }
          },
          "required": ["features","featureCount","startIndex"]
        }
      ]
    },

    "BlockByUrl": {
      "type": "object",
      "properties": { "url": { "type": "string" }, "featureCount": { "type": "integer" } },
      "required": ["url"]
    },

    "Grid": {
      "type": "object",
      "properties": {
        "width": { "type": "integer" },
        "height": { "type": "integer" },
        "base64": { "type": "string" },
        "binary": {},
        "url": { "type": "string" }
      },
      "minProperties": 3
    },

    "Triangles": {
      "type": "object",
      "properties": {
        "v": { "type": "array", "items": { "type": "number" } },
        "f": { "type": "array", "items": { "type": "integer" } }
      },
      "required": ["v","f"]
    },

    "TrianglesWithPolygons": {
      "type": "object",
      "properties": {
        "triangles": { "$ref": "#/$defs/Triangles" },
        "polygons": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "number" }
            }
          }
        }
      },
      "required": ["triangles"]
    },

    "Material": {
      "type": "object",
      "properties": {
        "type": { "type": "integer" },
        "c": { "type": "integer" },
        "o": { "type": "number" },
        "ds": { "type": "integer" },
        "t": { "type": "integer" },
        "w": { "type": "integer" },
        "flat": { "type": "integer" },
        "bm": { "type": "boolean" },
        "s": { "type": "number" },
        "dashed": { "type": "boolean" },
        "thickness": { "type": "number" },
        "image": {
          "type": "object",
          "properties": {
            "url": { "type": "string" },
            "base64": { "type": "string" },
            "object": {}
          },
          "minProperties": 1
        }
      },
      "additionalProperties": true
    },

    "MaterialUse": {
      "type": "object",
      "allOf": [
        { "$ref": "#/$defs/Material" },
        {
          "type": "object",
          "properties": {
            "mtlIndex": { "type": "integer" },
            "useNow": { "type": "boolean" }
          }
        }
      ]
    },

    "MaterialWrap": {
      "type": "object",
      "properties": { "mtl": { "$ref": "#/$defs/Material" } },
      "required": ["mtl"]
    },

    "Sides": {
      "type": "object",
      "properties": { "mtl": { "$ref": "#/$defs/Material" }, "bottom": { "type": "number" } },
      "required": ["mtl"]
    },

    "Model": {
      "type": "object",
      "properties": {
        "url": { "type": "string" },
        "base64": { "type": "string" },
        "ext": { "enum": ["dae","gltf","glb"] },
        "resourcePath": { "type": "string" }
      },
      "minProperties": 1
    },

    "Feature": {
      "type": "object",
      "properties": {
        "geom": { "$ref": "#/$defs/FeatureGeometry" },
        "mtl": { "type": "object" },
        "model": { "type": "integer" },
        "prop": { "type": "array" },
        "lbl": { "type": "string" },
        "lh": { "type": "number" },
        "anim": { "type": "object", "properties": { "delay": { "type": "integer" }, "duration": { "type": "integer" } } }
      },
      "required": ["geom"]
    },

    "FeatureGeometry": {
      "type": "object",
      "oneOf": [
        { "properties": { "pts": { "type": "array", "items": { "type": "number" } } }, "required": ["pts"] },
        { "properties": { "pts": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }, "r": { "type": "number" } }, "required": ["pts","r"] },
        { "properties": { "pts": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }, "r": { "type": "number" }, "h": { "type": "number" } }, "required": ["pts","r","h"] },
        { "properties": { "pts": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }, "w": { "type": "number" }, "d": { "type": "number" }, "h": { "type": "number" } }, "required": ["pts","w","d","h"] },
        { "properties": { "pts": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }, "r": { "type": "number" }, "d": { "type": "number" }, "dd": { "type": "number" } }, "required": ["pts","r","d","dd"] },
        { "properties": { "pts": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }, "w": { "type": "number" }, "l": { "type": "number" }, "d": { "type": "number" }, "dd": { "type": "number" } }, "required": ["pts","w","l","d","dd"] },
        { "properties": { "lines": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } } }, "required": ["lines"] },
        { "properties": { "lines": { "type": "array", "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } } }, "r": { "type": "number" } }, "required": ["lines","r"] },
        { "properties": { "lines": { "type": "array", "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } } }, "w": { "type": "number" }, "h": { "type": "number" } }, "required": ["lines","w","h"] },
        { "properties": { "bh": { "type": "number" }, "lines": { "type": "array", "items": { "type": "number" } } }, "required": ["bh","lines"] },
        { "$ref": "#/$defs/Triangles" },
        { "properties": { "polygons": { "type": "array" }, "centroids": { "type": "array" }, "h": { "type": "number" } }, "required": ["polygons","centroids","h"] },
        { "properties": { "triangles": { "$ref": "#/$defs/Triangles" }, "brdr": { "type": "array" } }, "required": ["triangles"] }
      ]
    }
  }
}
```

---

## Prompt

Please analyze Qgis2threejs.js and the Python code under core/build, and create an English document in Markdown that explains the data exchanged between Python and the web layer. Assume that the data is in JSON format, and create a JSON schema that describes the data structure.