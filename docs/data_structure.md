# Qgis2threejs Python → Web Data Structure Reference

Created: December 15, 2025

Note: This document was generated by AI (GitHub Copilot, GPT-5).

This document explains the JSON payloads produced by the Python export pipeline (under `core/build/`) and consumed by the Web runtime (`web/js/Qgis2threejs.js`). It focuses on what is passed, how fields are interpreted on the web side, and where each piece originates in the Python code.

- Producer: Python builders in [core/build](core/build) generate the scene, layers, blocks, materials, and optional model references.
- Consumer: The viewer logic in [web/js/Qgis2threejs.js](web/js/Qgis2threejs.js) loads the data via `app.loadData()` and builds a Three.js scene.
- Canonical schema: See [docs/schema/qgis2threejs.schema.json](docs/schema/qgis2threejs.schema.json) for a formal definition of the payloads.


## Top-Level Files

- Scene file: `data/<title>/scene.json` (or `scene.js` in local mode) written by [core/export/export.py](core/export/export.py).
- Optional block files: per-layer fragments `data/<title>/<A..Z>/<n>.json` created when layers are large; referenced from the scene.
- Runtime scripts and assets are copied alongside, including `Qgis2threejs.js`, Three.js libraries, and any model/image assets.


## Scene Object (`type: "scene"`)

- Produced by: `ThreeJSBuilder.buildScene()` in [core/build/builder.py](core/build/builder.py).
- Consumed by: `Q3DScene.loadData()` in [web/js/Qgis2threejs.js](web/js/Qgis2threejs.js).

Key fields (see `SceneProperties` in the schema):
- `baseExtent`: `{ cx, cy, width, height, rotation }` — Map extent in map coordinates.
- `origin`: `{ x, y, z }` — Origin used to convert map coords to world coords.
- `zScale`: number — Vertical exaggeration applied in the viewer.
- `light`: `"point" | "directional"` — Mapped to predefined light sets (see `Q3D.Config.lights`).
- `fog` (optional): `{ color, density }` — Creates `THREE.FogExp2`.
- `proj` (optional): string — Proj string used to display lat/lon if enabled.

Notes on consumption:
- The viewer computes a `pivot` and camera near/far from `baseExtent` and sets an initial viewpoint if none is provided.
- Map rotation is propagated to lights and scene nodes.
- `animation` at top-level (if present) is loaded by `app.animation.keyframes.load()`.


## Layer Object (`type: "layer"`)

- Produced by: layer-specific builders:
  - DEM: [core/build/dem/builder.py](core/build/dem/builder.py)
  - Vector: [core/build/vector/builder.py](core/build/vector/builder.py)
  - Point cloud: [core/build/pointcloud/builder.py](core/build/pointcloud/builder.py)
- Consumed by: `Q3DScene.loadData()` which instantiates one of:
  - `Q3DDEMLayer` for `properties.type == "dem"`
  - `Q3DPointLayer` for `"point"`
  - `Q3DLineLayer` for `"line"`
  - `Q3DPolygonLayer` for `"polygon"`
  - `Q3DPointCloudLayer` for `"pc"`

Common fields:
- `id`: string — Unique layer id used to route subsequent `block` payloads.
- `properties`:
  - `name`: display name.
  - `clickable`: enables identify/query in the viewer.
  - `visible`: initial visibility (forced `true` in preview mode).
  - `type`: one of `"dem" | "point" | "line" | "polygon" | "pc"`.
  - Optional: `propertyNames` (attribute field names), `label` (label styling; see schema), etc.
- `body` (optional):
  - `materials`: array of material definitions (see “Material” below).
  - `models`: array of external model references (glTF/DAE) for point layers with 3D models.
  - `blocks`: array of `Block` objects or file references.

Type-specific `properties` additions:
- DEM (`"dem"`): `clipped`, `mtlNames`, `mtlIdx` (current material index).
- Vector (`"point"|"line"|"polygon"`): `objType` (e.g., `"Sphere"`, `"Line"`, `"Extruded"`), `label` configuration.
- Point Cloud (`"pc"`): `url` (Potree dataset), `opacity`, `colorType`, `color` (if `COLOR`), `boxVisible`.


## Block Object (`type: "block"`)

- Purpose: Carries either a set of vector features or one DEM tile’s geometry and auxiliary options.
- Produced by:
  - Vector: [core/build/vector/feature_block_builder.py](core/build/vector/feature_block_builder.py).
  - DEM: [core/build/dem/grid_builder.py](core/build/dem/grid_builder.py) and material builder.
- Consumed by: `Q3DDEMLayer.loadData()` and `Q3DVectorLayer.loadData()` in the viewer.

Common fields:
- `layer`: target layer id.
- `block`: 0-based block index.
- `featureCount`, `startIndex`: feature counters used for labels and animations.

Vector feature blocks:
- `features`: array of Feature objects (see “Feature” below).
- When exported as separate files, a layer body may contain `{"url": "...", "featureCount": N}` instead of inline `block` content; the viewer fetches JSON files and feeds them to `app.loadJSONFile()`.

DEM blocks (regular grid):
- `width`, `height`: plane width/height in world units.
- `translate`: `[tx, ty, tz]` placement of the tile’s center.
- `zScale`: scalar applied to Z components.
- `grid`: `{ width, height, array | url | binary }` — elevation values, either inline `Float32Array`-compatible numbers, an external binary/JSON file, or a WebKit bridge object.
- Optional decorations:
  - `sides`: `{ mtl, bottom }` — build vertical sides and a bottom plane at Z=`bottom`.
  - `edges`: `{ mtl }` — draw frame lines around terrain edges.
  - `wireframe`: `{ mtl }` — add quad wireframe overlay.
- Materials per block:
  - `materials`: array where each item includes `mtlIndex` and `useNow`. The viewer selects the material with `useNow == true` for the block’s mesh and keeps others available for runtime switching (`setCurrentMaterial()`).

DEM blocks (clipped polygons):
- `geom`: either inline object or `url` referencing JSON:
  - `triangles`: `{ v, f }` — vertices and face indices; viewer computes normals/UVs.
  - `polygons`: array of polygon rings (for walls/bottom computations).
- `translate`, `zScale` behave as above.


## Feature Object (Vector Layers)

Produced by `FeatureBlockBuilder.build()` with geometry/material/model obtained from the active object type in [core/build/vector/object.py](core/build/vector/object.py). The viewer builds Three.js objects in `Q3DPointLayer`, `Q3DLineLayer`, and `Q3DPolygonLayer` accordingly.

Common optional members:
- `mtl`: `{ idx }` — index into the layer’s `body.materials` array.
- `model`: `{ idx }` — index into the layer’s `body.models` array (for `objType == "3D Model"`).
- `prop`: attribute values (ordered to match `layer.properties.propertyNames`). Used in the identify popup.
- `lbl`: label text; `lh`: label height (absolute or relative depending on `layer.properties.label.relative`).
- `anim`: `{ delay, duration }` — feature-level timing hints used by animations (e.g., growing lines).

Geometry variants (`geom`):
- Points
  - `Point`: `{ pts: [x,y,z, ...] }` (flat array).
  - `Sphere`: `{ pts: [[x,y,z], ...], r }`.
  - `Box`: `{ pts: [[x,y,z], ...], w, d, h }`.
  - `Cylinder`/`Cone`: `{ pts: [[x,y,z], ...], r, h }`.
  - `Disk`: `{ pts: [[x,y,z], ...], r, d, dd }` (dip, dip direction in degrees).
  - `Plane`: `{ pts: [[x,y,z], ...], w, l, d, dd }`.
  - `Billboard`: `{ pts: [[x,y,z], ...], size }`.
  - `3D Model`: `{ pts: [[x,y,z], ...], scale, rotateX, rotateY, rotateZ, rotateO? }`.
- Lines
  - `Line`/`Thick Line`: `{ lines: [ [x,y,z, ...], ... ] }` (each entry is a flat array of 3N numbers).
  - `Pipe`/`Cone`: `{ lines: [ [[x,y,z],...], ... ], r }`.
  - `Box`: `{ lines: [ [[x,y,z],...], ... ], w, h }`.
  - `Wall`: `{ lines: [ x,y,z, ... ], bh }` (flat; `bh` = base height).
- Polygons
  - `Polygon`/`Overlay`: `triangles` dictionary with `{ v, f }` and extra fields from `VectorGeometry` (e.g., `brdr` for borders in `Overlay`).
  - `Extruded`: `{ polygons: [[[x,y,z],...], ...], centroids: [[x,y,z],...], h }`.


## Material Object

Produced by `MaterialManager.build()`/`buildAll()` in [core/build/datamanager.py](core/build/datamanager.py). Consumed by `Q3DMaterial.loadData()` in the viewer.

Key fields:
- `type`: integer — maps to `Q3D.MaterialType` in the viewer:
  - `0` MeshLambert, `1` MeshPhong, `2` MeshToon, `3` Line, `4` MeshLine, `5` Sprite, `6` Point.
- `image`: for textured materials or sprites:
  - `{ url }` (exported/copy path), `{ base64 }` (inline), or `{ object }` (WebKit preview).
- `c`: color (integer), `o`: opacity [0..1], `ds`: double-sided, `flat`: flat shading, `bm`: basic/unlit material.
- Line/point specifics: `dashed` (Line), `thickness` (MeshLine), `s` (Point size), `w` (wireframe overlay flag), `t` (force transparent).
- DEM material management: `mtlIndex` (group id), `useNow` (select as current for a block).

How the viewer uses it:
- Creates the appropriate `THREE.*Material` and asynchronously loads textures.
- Applies anisotropy from `Q3D.Config.texture.anisotropy`.
- Groups materials by `mtlIndex` to support runtime switching in DEM layers.


## Runtime Flow

1) Python writes `scene.json` with `type:"scene"`, scene `properties`, and `layers`.
2) For each layer, `body.materials/models` are listed. Large layers provide `body.blocks` as inline arrays or `{ url, featureCount }` references.
3) The viewer loads the scene via `app.loadJSONFile()` or `app.loadData()`, then pulls any external blocks via HTTP and calls `app.loadData()` on them.
4) `Q3DScene.loadData()` dispatches to `Q3D*Layer.loadData()`, which constructs geoms, materials, and labels.


## Minimal Examples

Scene header:

```json
{
  "type": "scene",
  "properties": {
    "baseExtent": {"cx": 0, "cy": 0, "width": 1000, "height": 800, "rotation": 0},
    "origin": {"x": 0, "y": 0, "z": 0},
    "zScale": 1,
    "light": "directional"
  },
  "layers": [ /* Layer objects */ ]
}
```

Vector point layer (inline block):

```json
{
  "type": "layer",
  "id": "A",
  "properties": {"name": "Points", "clickable": true, "visible": true, "type": "point", "objType": "Sphere"},
  "body": {
    "materials": [{"type": 0, "c": 16711680}],
    "blocks": [{
      "type": "block", "layer": "A", "block": 0, "startIndex": 0, "featureCount": 1,
      "features": [{"geom": {"pts": [[10, 20, 0]]}, "mtl": {"idx": 0}, "lbl": "P1", "lh": 2}]
    }]
  }
}
```

DEM block (regular grid):

```json
{
  "type": "block",
  "layer": "D",
  "block": 0,
  "width": 1000,
  "height": 800,
  "translate": [0, 0, 0],
  "zScale": 1,
  "grid": {"width": 3, "height": 3, "array": [0, 1, 0, 1, 2, 1, 0, 1, 0]},
  "materials": [{"type": 0, "c": 10066329, "mtlIndex": 0, "useNow": true}]
}
```


## Cross-References

- Schema: [docs/schema/qgis2threejs.schema.json](docs/schema/qgis2threejs.schema.json)
- Viewer data loading: `Q3DScene.loadData()` in [web/js/Qgis2threejs.js](web/js/Qgis2threejs.js)
- Vector feature payloads: object types in [core/build/vector/object.py](core/build/vector/object.py)
- Material serialization: `MaterialManager` in [core/build/datamanager.py](core/build/datamanager.py)
- DEM builders: [core/build/dem](core/build/dem)
- Export entry points: [core/export/export.py](core/export/export.py)


## Updating the Contract

- Add or change fields in the Python builders and keep [docs/schema/qgis2threejs.schema.json](docs/schema/qgis2threejs.schema.json) in sync.
- Update the corresponding consumer in the viewer if semantics change.
- Prefer additive changes for backward compatibility; version gates can be introduced in the viewer if needed.
