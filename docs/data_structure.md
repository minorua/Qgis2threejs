# Qgis2threejs Data Structure Reference

Created: December 5, 2025

Note: This document was generated by AI (GitHub Copilot, GPT-5 mini).

This document describes the JSON data structure generated on the Python side (export) and passed to the browser-side `Qgis2threejs.js` (via `app.loadData()`).

Referenced implementation files:
- `web/js/Qgis2threejs.js`
- `web/viewer/viewer.js`
- `core/build/builder.py`
- `core/build/vector/feature_block_builder.py`
- `core/build/datamanager.py`
- `core/geometry.py`
- `core/export/export.py`
- `gui/webengineview.py`

Overview
- Purpose: transfer scene-wide properties (camera, lights, fog, etc.) and per-layer / per-block geometry and material data to three.js.
- Delivery method:
  - WebEngine: `Q3DWebEnginePage.sendData()` → `bridge.sendScriptData.emit("loadData(pyData())", data)` → JS executes `loadData(data)`
  - Local export: `scene.json` / `scene.js` is written and loaded by the viewer

---

Top-level: Scene object

Format:

```json
{
  "type": "scene",
  "properties": { ... },
  "layers": [ ... ]
}
```

Main fields in `properties`:
- `baseExtent`:
  - `cx`, `cy`: center coordinates
  - `width`, `height`: width and height
  - `rotation`: rotation in degrees
- `origin`: `{x, y, z}` — origin of the 3D world
- `zScale`: vertical scale factor (number)
- `light`: either `"point"` or `"directional"`
- `fog` (optional): `{ "color": intColor, "density": number }`
- `proj` (optional): projection string (proj4 or WKT) used for coordinate display when provided

---

Layer object

Format:

```json
{
  "type": "layer",
  "id": "<jsLayerId>",
  "properties": { ... },
  "body": { ... }
}
```

Main keys in `properties`:
- `name`: layer name (string)
- `clickable`: boolean
- `visible`: boolean
- `type`: one of `"point"`, `"line"`, `"polygon"`
- `objType`: object type name (example: `"3D Model"`, `"Extruded"`)
- `propertyNames` (optional): array of attribute field names exported
- `label` (optional): label settings (`relative`, `font`, `size`, `color`, etc.)

Main elements in `body`:
- `materials` (array): produced by `MaterialManager.buildAll` — an array of material description objects
- `models` (array): produced by `ModelManager.build` — a list of model descriptors (e.g. `{ "url": "..." }`)
- `blocks` (array) or `url` to block files when large datasets are split into separate block files

---

Material object (`body.materials` entries)

Common keys (examples):
- `type`: material type (numeric; 0=MeshLambert, 1=MeshPhong, 2=MeshToon, 3=Line, 4=MeshLine, 5=Sprite, 6=Point)
- `image`: `{ "url": "..." }` or `{ "base64": "..." }` for image-based materials
- `c`: color (integer)
- `s`: size (for Point)
- `dashed`: dashed flag (for Line)
- `thickness`: thickness (for MeshLine)
- `t`: transparent background flag (1)
- `w`: wireframe flag (1)
- `flat`: flat shading flag
- `o`: opacity (0..1)
- `ds`: double-sided flag (1)
- `bm`: shading off (boolean)

---

Block object

FeatureBlockBuilder generates blocks which are sent incrementally during preview:

```json
{
  "type": "block",
  "layer": "<jsLayerId>",
  "block": 0,
  "features": [ ... ],
  "featureCount": N,
  "startIndex": 0
}
```

When exporting to files, block JSON files are created and the builder returns objects such as `{ "url": "./data/.../0.json", "featureCount": n }` to indicate a block file.

---

Feature

Common keys in a feature object:
- `geom`: geometry object (see below)
- `mtl` (optional): material reference (often an index object like `{ "idx": N }`)
- `model` (optional): model reference (index or descriptor)
- `prop` (optional): attribute object (key-value pairs)
- `lbl` (optional): label text
- `lh` (optional): label height
- `anim` (optional): animation parameters, e.g. `{ "delay": n, "duration": n }`

---

Geometry (`geom`) representations (common cases)

- Point types:
  - Flat array form: `{ "pts": [x1, y1, z1, x2, y2, z2, ...] }`
- Line types:
  - Example: `{ "lines": [[x1,y1,z1,x2,y2,z2,...], [...]] }` (array of line vertex lists)
- Polygon / TIN:
  - TIN (from `toDict()`):
    ```json
    {
      "triangles": {
        "v": [[x,y,z], ...],
        "f": [[i0,i1,i2], ...]
      },
      "centroids": [[x,y,z], ...]  // optional
    }
    ```
  - Extruded polygons and overlays may use `polygons`, `centroids`, and `h` (height) keys.

Notes: The JS side accepts both "flat" (flattened numeric arrays) and nested list forms in many places.

---

Concrete JSON examples

Below is a simplified handcrafted example saved to `docs/examples/scene_example.json`.

- `scene_example.json` contains a full scene example (one polygon layer with one feature in a single block).
- The markdown also contains small snippets for point and line examples.

Point snippet example
```json
{"type":"layer","id":"L0","properties":{"name":"Points","clickable":true,"visible":true,"type":"point","objType":"Point"},"body":{"materials":[{"type":6,"c":16763904,"s":3}] ,"blocks":[{"type":"block","layer":"L0","block":0,"features":[{"geom":{"pts":[0,0,10]},"mtl":{"idx":0},"prop":{"id":1}}],"featureCount":1,"startIndex":0}]}}
```

Line snippet example
```json
{"type":"layer","id":"L1","properties":{"name":"Lines","clickable":true,"visible":true,"type":"line","objType":"Line"},"body":{"materials":[{"type":3,"c":16711680,"o":0.8}],"blocks":[{"type":"block","layer":"L1","block":0,"features":[{"geom":{"lines":[[0,0,0,10,0,0,10,10,0]]},"mtl":{"idx":0}}],"featureCount":1,"startIndex":0}]}}
```

---

Implementation notes
- `body.materials` is an array; features typically reference materials by index via `mtl`.
- Image materials include `image.url` or `image.base64` depending on export mode and settings.
- Large datasets are split into blocks; block JSON files may be written out and referenced by URL.
- Coordinate handling: if `properties.proj` is present, JS uses it for coordinate display (e.g. lat/lon).
- Type/format notes: many geometry arrays exist in both "flat" and nested forms; JS code handles both forms.

---
